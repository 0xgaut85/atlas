# x402+eip712 Scheme Specification

## Overview

The `x402+eip712` scheme enables payment verification on EVM-compatible blockchains using EIP-712 typed data signatures and transaction hashes.

## Network Support

- Base Mainnet (Chain ID: 8453)
- Base Sepolia (Chain ID: 84532)
- Ethereum Mainnet (Chain ID: 1) - Coming Q2 2026
- Polygon (Chain ID: 137) - Coming Q1 2026

## Payment Payload

```typescript
interface EIP712PaymentPayload {
  transactionHash: string; // 0x-prefixed hex string
  amount: string; // Amount in micro units (e.g., "1000000" for 1 USDC)
  currency: string; // Asset identifier (e.g., "USDC")
  payTo: string; // 0x-prefixed address
  nonce?: number; // Optional transaction nonce
  chainId: number; // Chain ID for the network
}
```

## Verification Process

1. **Fetch Transaction**: Query blockchain RPC for transaction by hash
2. **Verify Status**: Ensure transaction status is `"success"` (status === 1)
3. **Verify Recipient**: Check that `to` address matches `payTo`
4. **Verify Amount**: Parse transaction logs to verify USDC transfer amount
5. **Verify Asset**: Ensure transfer is from correct USDC contract
6. **Verify Timing**: Check transaction block timestamp is within timeout window

## USDC Contract Addresses

- Base: `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`
- Ethereum: `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48`
- Polygon: `0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174`

## Example Implementation

```typescript
import { verifyEIP712Payment } from '@atlas402/x402-server';

const result = await verifyEIP712Payment({
  transactionHash: '0x1234...',
  network: 'base',
  rpcUrl: 'https://mainnet.base.org',
  expectedAmount: '1000000',
  expectedRecipient: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
  expectedAsset: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
  timeoutSeconds: 60,
});

if (result.isValid) {
  // Payment verified, serve content
} else {
  // Payment invalid: result.invalidReason
}
```

## Error Handling

Common verification failures:

- `INVALID_TRANSACTION`: Transaction not found or failed
- `WRONG_RECIPIENT`: Recipient address mismatch
- `WRONG_AMOUNT`: Amount mismatch
- `WRONG_ASSET`: Asset contract mismatch
- `EXPIRED`: Transaction too old
- `NETWORK_ERROR`: RPC connection failed

## Security Considerations

- Always verify on-chain, never trust client-provided data
- Use facilitator service for production deployments
- Implement proper rate limiting
- Cache verification results to avoid repeated RPC calls
- Monitor for replay attacks using nonce/timestamp

